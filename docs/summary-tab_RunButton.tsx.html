

<!DOCTYPE html>
<html lang="en">

<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title> summary-tab/RunButton.tsx</title>

  <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="./build/entry.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,400,700|Inconsolata,700" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
  <link type="text/css" rel="stylesheet" href="https://jmblog.github.io/color-themes-for-google-code-prettify/themes/tomorrow-night.min.css">
  <link type="text/css" rel="stylesheet" href="styles/app.min.css">
  <link type="text/css" rel="stylesheet" href="styles/iframe.css">
  <link type="text/css" rel="stylesheet" href="">
  <script async defer src="https://buttons.github.io/buttons.js"></script>

  
</head>



<body class="layout small-header">
    <div id="stickyNavbarOverlay"></div>
    

<div class="top-nav">
    <div class="inner">
        <a id="hamburger" role="button" class="navbar-burger" aria-label="menu" aria-expanded="false">
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
            <span aria-hidden="true"></span>
        </a>
        <div class="logo">
            
            
        </div>
        <div class="menu">
            
            <div class="navigation">
                <a
                    href="index.html"
                    class="link"
                >
                    Documentation
                </a>
                
                
                
            </div>
        </div>
    </div>
</div>
    <div id="main">
        <div
            class="sidebar "
            id="sidebarNav"
        >
            
            <nav>
                
                    <h2><a href="index.html">Documentation</a></h2><div class="category"><h3>Components / Results</h3><ul><li><a href="BarGraphModal.html">BarGraphModal</a></li><li><a href="ColorsScale.html">ColorsScale</a></li><li><a href="DoubleYAxis.html">DoubleYAxis</a></li><li><a href="GraphAndMapMetaModal.html">GraphAndMapMetaModal</a></li><li><a href="GraphAndMapMonoModal.html">GraphAndMapMonoModal</a></li><li><a href="GraphicAndMapResults.html">GraphicAndMapResults</a></li><li><a href="GraphModal.html">GraphModal</a></li><li><a href="MapResults.html">MapResults</a></li><li><a href="MetaMapResults.html">MetaMapResults</a></li><li><a href="MetapopulationSelectTable.html">MetapopulationSelectTable</a></li><li><a href="PlayDataSlider.html">PlayDataSlider</a></li><li><a href="RealDataCheckBoxs.html">RealDataCheckBoxs</a></li><li><a href="ResultsDrawer.html">ResultsDrawer</a></li><li><a href="ResultsMapsSelection.html">ResultsMapsSelection</a></li><li><a href="ResultsSelection.html">ResultsSelection</a></li></ul><h3>Components</h3><ul><li><a href="CountiesSelect.html">CountiesSelect</a></li><li><a href="GeoSelectionsTab.html">GeoSelectionsTab</a></li><li><a href="NumberInputEpi.html">NumberInputEpi</a></li><li><a href="NumberInputVariableDependent.html">NumberInputVariableDependent</a></li><li><a href="ResetAlerts.html">ResetAlerts</a></li><li><a href="SelectedFeaturesPanel.html">SelectedFeaturesPanel</a></li><li><a href="StatesSelect.html">StatesSelect</a></li><li><a href="StatesSelectedCheckbox.html">StatesSelectedCheckbox</a></li></ul><h3>Components / DataFitTab</h3><ul><li><a href="EndPointSource.html">EndPointSource</a></li><li><a href="FileSource.html">FileSource</a></li><li><a href="FitParameterTable.html">FitParameterTable</a></li><li><a href="FitParemetersTabs.html">FitParemetersTabs</a></li><li><a href="GraphicDataFit.html">GraphicDataFit</a></li><li><a href="MetapopulationDataFit.html">MetapopulationDataFit</a></li><li><a href="MonopopulationDataFit.html">MonopopulationDataFit</a></li><li><a href="NodeSearchFilter.html">NodeSearchFilter</a></li><li><a href="SampleSource.html">SampleSource</a></li></ul><h3>Components / models-tab</h3><ul><li><a href="ExportModels.html">ExportModels</a></li><li><a href="ImportModels.html">ImportModels</a></li></ul><h3>Components / MapTab</h3><ul><li><a href="GeoSelectionsDetails.html">GeoSelectionsDetails</a></li><li><a href="GeoToastMessage.html">GeoToastMessage</a></li><li><a href="SelectorMap.html">SelectorMap</a></li><li><a href="SelectorMapAccordion.html">SelectorMapAccordion</a></li></ul><h3>Components / NewModel</h3><ul><li><a href="InitialConditiosModels.html">InitialConditiosModels</a></li><li><a href="ModelAccordion.html">ModelAccordion</a></li><li><a href="ModelBuilder.html">ModelBuilder</a></li><li><a href="ModelController.html">ModelController</a></li><li><a href="ModelMainTab.html">ModelMainTab</a></li><li><a href="SelectDate.html">SelectDate</a></li></ul><h3>Components / Summary tab</h3><ul><li><a href="RunButton.html">RunButton</a></li><li><a href="TableSimulations.html">TableSimulations</a></li></ul><h3>Global</h3><ul><li><a href="global.html#getArrayParametersByNode">getArrayParametersByNode</a></li><li><a href="global.html#getColor">getColor</a></li><li><a href="global.html#getGeoNames">getGeoNames</a></li><li><a href="global.html#getInitialConditionsByModel">getInitialConditionsByModel</a></li><li><a href="global.html#getMetaObj">getMetaObj</a></li><li><a href="global.html#getParametersFitModel">getParametersFitModel</a></li><li><a href="global.html#getPreviusInitialConditions">getPreviusInitialConditions</a></li><li><a href="global.html#getSEIRHVDObjMono">getSEIRHVDObjMono</a></li><li><a href="global.html#getSEIRObjMono">getSEIRObjMono</a></li><li><a href="global.html#getSIRObjMono">getSIRObjMono</a></li><li><a href="global.html#postInitialConditionsByModel">postInitialConditionsByModel</a></li></ul></div><div class="category"><h2>DataFitTab</h2><h3>Components</h3><ul><li><a href="DataFitTab.html">DataFitTab</a></li></ul></div><div class="category"><h2>MapTab</h2><h3>Components</h3><ul><li><a href="Map.html">Map</a></li></ul></div><div class="category"><h2>NewModel</h2><h3>Components</h3><ul><li><a href="NewModel.html">NewModel</a></li></ul></div><div class="category"><h2>Results</h2><h3>Components</h3><ul><li><a href="Results.html">Results</a></li></ul></div><div class="category"><h2>Summary tab</h2><h3>Components</h3><ul><li><a href="SummaryTab.html">SummaryTab</a></li></ul></div>
                
            </nav>
        </div>
        <div class="core" id="main-content-wrapper">
            <div class="content">
                <header class="page-title">
                    <p>Source</p>
                    <h1>summary-tab/RunButton.tsx</h1>
                </header>
                



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* eslint-disable sonarjs/cognitive-complexity */
/* eslint-disable complexity */
/* eslint-disable @typescript-eslint/dot-notation */
import { Button, Spinner, Text, useToast } from "@chakra-ui/react";
import { format, add } from "date-fns";
import { useContext, useState } from "react";

import { GraphicsData } from "context/GraphicsContext";
import { NewModelSetted } from "context/NewModelsContext";
import { SelectFeature } from "context/SelectFeaturesContext";
import { TabIndex } from "context/TabContext";
import { NewModelsAllParams } from "types/SimulationTypes";
import createIdComponent from "utils/createIdcomponent";
import postData from "utils/fetchData";

import getMetaObj from "./getMetaObj";
import getSEIRHVDObjMono from "./getSEIRHVDObjMono";
import getSEIRObjMono from "./getSEIRObjMono";
import getSIRObjMono from "./getSIRObjMono";

// eslint-disable-next-line sonarjs/no-duplicate-string
const bottonLeft = "bottom-left";
type ReducedIdForPermissions = Record&lt;number, boolean>;

interface Props {
    permission: ReducedIdForPermissions;
}
const SIMULATIONFAILED = "Simulation failed";

/**
 * Component that communicates with the necessary endpoints to obtain the real and simulated data of the selected models.
 * @subcategory Summary tab
 * @component
 */
const RunButton = ({ permission }: Props) => {
    const { geoSelections } = useContext(SelectFeature);
    // Real Data Context
    const { setRealDataSimulationKeys } = useContext(GraphicsData);
    //
    const toast = useToast();
    const { setAux, setIndex } = useContext(TabIndex);
    const {
        setAllGraphicData,
        setAllResults,
        setDataToShowInMap,
        setGlobalParametersValues,
    } = useContext(GraphicsData);
    const [isSimulating, setisSimulating] = useState(false);
    const {
        completeModel,
        setSelectedModelsToSimulate,
        setSimulationsPopulatioType,
    } = useContext(NewModelSetted);

    /**
     * Gets the configuration object to request the real data from the "realData" endpoint.
     * @param {NewModelsAllParams[]} selectedModels monopopulation models selected to simulate.
     * @returns {Obejct}
     */
    const getObjectConfig = (selectedModels) => {
        const simulationsSelected = selectedModels.map((e, i) => {
            const geoSetted = geoSelections.find((geo) => geo.id === e.idGeo);
            const timeEnd = add(new Date(e.t_init), {
                days: e.parameters.t_end,
            });
            return {
                name: e.name,
                compartments: e.parameters.name,
                timeInit: format(new Date(e.t_init), "yyyy-MM-dd"),
                timeEnd: format(timeEnd, "yyyy-MM-dd"),
                scale: geoSetted?.scale,
                spatialSelection: geoSetted?.featureSelected,
            };
        });

        const geoSimulationsOnly = simulationsSelected.filter((sim) => {
            return sim.scale !== undefined;
        });

        return geoSimulationsOnly.reduce((acc, it) => {
            return {
                ...acc,
                [`${it.name}`]: it,
            };
        }, {});
    };

    /**
     * Obtains the real data from the simulated monopopulation models.
     * @param {NewModelsAllParams[]} selectedModels monopopulation models selected to simulate..
     * @returns returns a list with the name of the model and the actual values of its parameters.
     */
    const getGraphicRealData = async (selectedModels) => {
        const objectConfig = getObjectConfig(selectedModels);
        try {
            if (Object.keys(objectConfig).length > 0) {
                const res = await postData(
                    "http://192.168.2.131:5002/api/v0/realData",
                    // "http://192.168.2.131:5002/realData",
                    objectConfig
                );
                const val = Object.values(res);
                const keys = Object.keys(res);
                const realDataKeys = val
                    .map((simString: string) => simString)
                    .map((sim, i) => ({
                        name: keys[i],
                        // eslint-disable-next-line @typescript-eslint/ban-types
                        ...(sim as {}),
                    }));

                return setRealDataSimulationKeys(realDataKeys);
            }
            return false;
        } catch (error) {
            return toast({
                position: "bottom-left",
                title: "Error",
                description: `${error.message}`,
                status: "error",
                duration: 3000,
                isClosable: true,
            });
        }
    };

    /**
     * Obtains the real data from the simulated metapopulation models.
     * @param {NewModelsAllParams[]} selectedModels metapopulation models selected to simulate.
     * @returns returns a list with the name of the model and the actual values of its parameters.
     */
    const getGraphicRealMetaData = async (selectedModels) => {
        const objectConfig = getObjectConfig(selectedModels);
        try {
            if (Object.keys(objectConfig).length > 0) {
                const res = await postData(
                    "http://192.168.2.131:5002/api/v0/realData?type=metapopulation",
                    // "http://192.168.2.131:5002/realData",
                    objectConfig
                );

                const listRealDataResponse = Object.keys(res).map((key) => {
                    return { name: key, ...res[key] };
                });

                return setRealDataSimulationKeys(listRealDataResponse);
            }
            return false;
        } catch (error) {
            return toast({
                position: "bottom-left",
                title: "Error",
                description: `${error.message}`,
                status: "error",
                duration: 3000,
                isClosable: true,
            });
        }
    };

    /**
     * Return the scale and fips of the chosen counties or states.
     * @param id model id.
     * @returns {Object}
     */
    const getScaleAndFeaturesSelected = (id) => {
        const geoselectionItems = geoSelections.find((g) => g.id === id) || {};
        const {
            scale,
            featureSelected,
        }: { scale?: string; featureSelected?: string[] } =
            (typeof geoselectionItems !== "undefined" &amp;&amp; geoselectionItems) ||
            {};

        return { scale, featureSelected };
    };

    /**
     * Gets objects according to model types chosen to be simulated.
     * @param {NewModelsAllParams[]} simulations selected models to simulate.
     * @returns {Object} differentiated according to SIR, SEIR, SERHVD model.
     */
    const getSimulationSelectedObj = (simulations) => {
        return simulations.map((e) => {
            const { scale, featureSelected } = getScaleAndFeaturesSelected(
                e.idGeo
            );
            if (e.modelType === "seirhvd") {
                return getSEIRHVDObjMono(
                    e,
                    e.parameters,
                    scale,
                    featureSelected
                );
            }
            if (e.modelType === "sir") {
                return getSIRObjMono(e, e.parameters, scale, featureSelected);
            }
            return getSEIRObjMono(e, e.parameters, scale, featureSelected);
        });
    };

    /**
     * Returns a list with the selected models to simulate.
     * @returns {NewModelsAllParams[]}
     */
    const getSelectedModel = () => {
        let selectedModels = [];
        completeModel.map((model) => {
            if (permission[model.idNewModel]) {
                selectedModels = [...selectedModels, model];
                return selectedModels;
            }
            return false;
        });
        return selectedModels;
    };

    /**
     * Saves the results of a single-population simulation.
     * @param response result of the call to the "simulate" endpoint.
     * @param {NewModelsAllParams[]} selectedModels
     */
    const setMonopopulationData = (response, selectedModels) => {
        const val = Object.values(response.results);
        const keys = Object.keys(response.results);
        const data = val
            .map((simString: string) => JSON.parse(simString))
            .map((sim, i) => ({
                name: keys[i],
                ...sim,
            }));
        setAllGraphicData([]);
        setAllResults([]);
        setDataToShowInMap([]);
        // setAllResults([].concat(dataToShowInMap, []));
        setRealDataSimulationKeys([]);
        setAux(JSON.stringify(data));
        setSelectedModelsToSimulate(selectedModels);
        getGraphicRealData(selectedModels);
        setIndex(5);
    };

    /**
     * Result of the call to the "simulate" endpoint.
     */
    // eslint-disable-next-line sonarjs/cognitive-complexity
    const handleJsonToToml = async () => {
        setisSimulating(true);
        try {
            if (completeModel.length &lt; 1) {
                throw new Error("You must add a simulation at least");
            }
            const selectedModels = getSelectedModel();
            // build object simulation template for toml
            const simulationsSelected =
                getSimulationSelectedObj(selectedModels);

            const objConfig = simulationsSelected.reduce((acc, it, i) => {
                const simName = completeModel.find(
                    (sim: NewModelsAllParams) => {
                        return sim.idNewModel === it.idSim;
                    }
                );
                return {
                    ...acc,
                    [`${simName.name}`]: it,
                };
            }, {});
            if (simulationsSelected.length > 0) {
                const { populationType } = completeModel.find(
                    (sim: NewModelsAllParams) => {
                        return sim.idNewModel === simulationsSelected[0].idSim;
                    }
                );
                let response;
                if (populationType === "metapopulation") {
                    const { scale, featureSelected } =
                        getScaleAndFeaturesSelected(selectedModels[0].idGeo);
                    const metaSimulationsSelected = getMetaObj(
                        selectedModels[0],
                        scale,
                        featureSelected
                    );
                    const metaObjectConfig = {
                        [`${selectedModels[0].name}`]: metaSimulationsSelected,
                    };
                    response = await postData(
                        "http://192.168.2.131:5003/simulate_meta",
                        metaObjectConfig
                    );
                    const name = `${selectedModels[0].name}`;

                    const jsonResponse = await JSON.parse(
                        response.results[name]
                    );

                    const jsonGlobalResultsResponse = await JSON.parse(
                        response.global_results[name]
                    );
                    const listResponse = Object.keys(jsonResponse).map(
                        (key) => {
                            return { name: key, ...jsonResponse[key] };
                        }
                    );

                    let globalResultsListResponse = { name: "general" };
                    Object.keys(jsonGlobalResultsResponse).forEach((key) => {
                        globalResultsListResponse = {
                            ...globalResultsListResponse,
                            [key]: Object.values(
                                jsonGlobalResultsResponse[key]
                            ),
                        };
                    });

                    setAllGraphicData([]);
                    setAllResults([]);
                    setDataToShowInMap([]);
                    setRealDataSimulationKeys([]);
                    setAux(JSON.stringify(listResponse));
                    setGlobalParametersValues(
                        JSON.stringify([globalResultsListResponse])
                    );
                    setSelectedModelsToSimulate(selectedModels);
                    getGraphicRealMetaData(selectedModels);
                    setIndex(5);
                } else {
                    response = await postData(
                        "http://192.168.2.131:5003/simulate",
                        objConfig
                    );
                    setMonopopulationData(response, selectedModels);
                }
            }
            toast({
                position: bottonLeft,
                title: "Simulation success",
                description: "Your simulation was completed successfully",
                status: "success",
                duration: 3000,
                isClosable: true,
            });
        } catch (error) {
            if (error.response?.status === 400) {
                toast({
                    position: bottonLeft,
                    title: SIMULATIONFAILED,
                    description: "Parameters are invalid. Check your models!",
                    status: "error",
                    duration: 3000,
                    isClosable: true,
                });
            } else {
                toast({
                    position: bottonLeft,
                    title: SIMULATIONFAILED,
                    description: `${error.message}`,
                    status: "error",
                    duration: 3000,
                    isClosable: true,
                });
            }
        } finally {
            setisSimulating(false);
        }
    };

    return (
        &lt;>
            &lt;Button
                id={createIdComponent()}
                onClick={() => {
                    const withPermission = Object.values(permission).some(
                        (perm) => perm
                    );
                    if (withPermission) {
                        handleJsonToToml();
                        setSimulationsPopulatioType("");
                    } else {
                        toast({
                            position: bottonLeft,
                            title: SIMULATIONFAILED,
                            description: `You must select at least one model`,
                            status: "error",
                            duration: 3000,
                            isClosable: true,
                        });
                    }
                }}
                colorScheme="blue"
                color="white"
            >
                {isSimulating ? (
                    &lt;>
                        &lt;Spinner
                            id={createIdComponent()}
                            thickness="4px"
                            speed="0.65s"
                            emptyColor="gray.200"
                            color="blue.500"
                        />
                        &lt;Text id={createIdComponent()} pl="1rem">
                            Simulating...
                        &lt;/Text>
                    &lt;/>
                ) : (
                    `Run`
                )}
            &lt;/Button>
        &lt;/>
    );
};

export default RunButton;
</code></pre>
        </article>
    </section>




            </div>
            
            <footer class="footer">
                <div class="content has-text-centered">
                    <p>Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a></p>
                    <p class="sidebar-created-by">
                        <a href="https://github.com/SoftwareBrothers/better-docs" target="_blank">BetterDocs theme</a> provided with <i class="fas fa-heart"></i> by
                        <a href="http://softwarebrothers.co" target="_blank">SoftwareBrothers - JavaScript Development Agency</a>
                    </p>
                </div>
            </footer>
            
        </div>
        <div id="side-nav" class="side-nav">
        </div>
    </div>
<script src="scripts/app.min.js"></script>
<script>PR.prettyPrint();</script>
<script src="scripts/linenumber.js"> </script>


</body>
</html>
